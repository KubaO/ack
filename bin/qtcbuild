#! /bin/bash
# Use with Qt Creator to redirect gcc error output to stderr
AWK_MACPORTS=/opt/local/bin/gawk
AWK=$(which gawk)
if [ -z "$AWK" ]; then
  if [ -x "$AWK_MACPORTS" ]; then
    AWK="$AWK_MACPORTS"
  else
    AWK=$(which awk)
  fi
fi
if [ -z "$AWK" ]; then
  echo "Cannot find gawk nor awk" >&2
  exit 1
fi

if [ -z "$BUILDSYSTEM" ]; then
  export BUILDSYSTEM=ninja
fi
if [ -z "$PREFIX" ]; then
  export PREFIX=~/ack
fi
if [ -z "$NINJAFLAGS" ]; then
  export NINJAFLAGS=-k100
fi
if [ -z "$MAKEFLAGS" ]; then
  export MAKEFLAGS=-k
fi

# ninja and general progress goes to stdout, 
# compiler errors go to stderr - as Qt Creator expects.
# This is necessary to connect compile output to the Issues pane.
OUT_SCRIPT_='\
             { errorline = ($0 !~ /^\[/) && ($0 !~ /^loading .+\.lua$/) && ($0 !~ /^Bootstrapping build$/) }  \
  / gcc /    { match($0, / +([^ ]+\.c) /, arr); fn=arr[1] }  \
  errorline  { print $0 > "/dev/stderr"; fflush("/dev/stderr"); }  \
  !errorline { print $0; fflush("/dev/stdout"); }  \
'
make -e "$@" 2>&1 | $AWK "$OUT_SCRIPT_"
#make -e "$@" 2>&1
